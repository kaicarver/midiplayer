<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Kai&apos;s MIDI player</title>
    <!-- polyfill -->
    <script src="inc/shim/Base64.js" type="text/javascript"></script>
    <script src="inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="js/midi/gm.js" type="text/javascript"></script>
    <script src="js/midi/loader.js" type="text/javascript"></script>
    <script src="js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="js/util/dom_request_script.js" type="text/javascript"></script>

    <style type="text/css">
      body { font-family: Arial; }
      #playWord { width: 30em; }
      a { text-decoration: none; }
    </style>
    
  </head>
  <body>
    <script type="text/javascript">
      
      window.onload = function () {
	var instruments = Object.keys(MIDI.GM.byName);
	var html = "";
	for (var key in MIDI.GM.byName) {
	  html += '<option value="'+key+'">'+key+'</option>';
	}
	document.getElementById("midiInstruments").innerHTML = html;
	MIDI.loadPlugin({
	  soundfontUrl: "../midi-js-soundfonts/FluidR3_GM/",
	  //soundfontUrl: "./soundfont/",
	  instrument: "acoustic_grand_piano",
	  //instruments: ["acoustic_grand_piano", "harpsichord", "church_organ"],
	  onprogress: function(state, percent) {
	    //console.log(state, percent);
	    document.getElementById("status").innerText += ". ";
	  },
	  onsuccess: function() {
	    console.log("loadPlugin success!");
	    MIDI.programChange(0, MIDI.GM.byName["acoustic_grand_piano"].number);
	    //MIDI.programChange(1, MIDI.GM.byName["harpsichord"].number);
	    //MIDI.programChange(2, MIDI.GM.byName["church_organ"].number);
	    document.getElementById("status").innerText = "";
	    //document.getElementById("playButton").innerText = "Play";
	  }
	});
      };

      function loadInstrument(instrumentName, channel) {
	var instrumentName = document.getElementById('midiInstruments').value;
	var channel = document.getElementById("playChannel").value;
	document.getElementById("status").innerText = "loading " + instrumentName + " to channel " + channel;
	MIDI.loadResource({
	  instrument: instrumentName,
	  onprogress: function(state, percent) {
	    //console.log(state, percent);
	    document.getElementById("status").innerText += ". ";	    
	  },
	  onsuccess: function() {
	    MIDI.programChange(channel, MIDI.GM.byName[instrumentName].number);
	    document.getElementById("status").innerText = "";
	    console.log("loaded " + instrumentName + " on channel " + channel);
	  }
	})
      }

      chords = [[37,59,61,71,80],[38,60,62,72,81],[39,61,63,73,82]];
      function playChords() {
	for (var i = 0; i < 9; i++){
	  playChord(i/2, chords[i%chords.length]);
	}	
      }
      function playChord(delay, chord) {
        MIDI.chordOn(0, chord, 127, delay);
        MIDI.chordOff(0, chord, delay+1);
      }

      function playText() {
	var text = document.getElementById("playText").value;
	var channel = document.getElementById("playChannel").value;
	playMelody(text.split(","), channel);
      }
      function playWord() {
	var word = document.getElementById("playWord").value;
	var channel = document.getElementById("playChannel").value;
	var notes = text2Notes(word);
	playMelody(notes, channel);
	var notesArray = '['+notes.join(',')+']';
	document.getElementById("melodies").innerHTML += '<a href="javascript:void(playMelody('+notesArray+','+channel+'))">' + word + '</a> ';
      }
      var note2code = { "C" : 60, "D" : 62, "E" : 64, "F" : 65, "G" : 67, "A" : 69, "B" : 71,
			"c" : 72, "d" : 74, "e" : 76, "f" : 77, "g" : 79, "a" : 81, "b" : 83 }
      var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");
      var notes = "ABCDEFGABCDEFGABCDEFGABCDEabcdefgabcdefgabcdefgabcde".split("");
      var char2note = {};
      for (var i = 0; i < chars.length; i++) {
	char2note[chars[i]] = notes[i];
      }
      function text2Notes(text) {
	var letters = text.split("");
	var notes = [];
	for (var i = 0; i < letters.length; i++) {
	  notes[i] = note2code[char2note[letters[i]]];
	  //console.log(letters[i], notes[i]);
	}
	return notes;
      }
      function playMelody(notes, channel) {
	//var melody = "C D E"; // ABC notation
	//melody = "C4 D4 E4 ..."; // converted to note names
	//melody = "60,62,64,65,67,69,71,72";
	//var notes = [50,52,54,50,52,54]; // the MIDI notes
	//var notes = [60,62,64,65,67,69,71,72,71,69,67,65,64,62,60,62,64,65,67,69,71,72,71,69,67,65,64,62,60]; // the MIDI notes
	//notes = melody.split(' ');
	var velocity = 100; // how hard the note hits
	var delay = 0;
	var noteDuration = 0.2;
	var noteFrequency = 0.1;
	// play the notes
	for (var i = 0; i < notes.length; i++) {
	  //console.log("play Midi note " + notes[i] + "=" + MIDI.noteToKey[notes[i]]);
	  MIDI.noteOn(channel, notes[i], velocity, delay);
	  MIDI.noteOff(channel, notes[i], delay + noteDuration);
	  delay += noteFrequency;
	}
	//console.log(MIDI.keyToNote["C4"]); // A0 => 21
      }
    </script>
    <div>
      <input type="text" id="playWord" value="Happy Birthday Leonore!"/>
      <button id="playWordButton" onclick="playWord()">Play</button>
    </div>
    <div id="melodies"></div>
    
    <div>
      <select id="midiInstruments">
      </select>
      <select id="playChannel">
	<option value="0" selected="selected">0</option> 
	<option value="1">1</option>
	<option value="2">2</option>
	<option value="3">3</option>
	<option value="4">4</option>
	<option value="5">5</option>
	<option value="6">6</option>
	<option value="7">7</option>
	<option value="8">8</option>
	<option value="9">9</option>
	<option value="10">10</option>
	<option value="11">11</option>
	<option value="12">12</option>
	<option value="13">13</option>
	<option value="14">14</option>
	<option value="15">15</option>
      </select>
      <button id="loadNew" onclick="loadInstrument()">Load new</button>
    </div>
    <div><span id="status">loading sounds</span></div>

    <pre>
      Idea: make a kind of text with words that when you click on them make music.
      Idea: use ABC notation on full alphabet, at least for octave, maybe also duration, maybe also incidentals
    </pre>

    <!--
    <div>
      <input type="text" id="playText" value="60,62,64,65,67,69,71,72"/>
    </div>
    <div><button id="playButton" onclick="playText()">Loading sounds</button></div>
    <div><button id="playChords" onclick="playChords()">Play Chords</button></div>
    -->
  </body>
</html>
